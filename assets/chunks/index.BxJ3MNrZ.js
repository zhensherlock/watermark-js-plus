const L=n=>n.toDataURL("image/png",1),w=n=>typeof n=="function",o=n=>n===void 0,x=n=>typeof n=="string",m=(n,t={},i="http://www.w3.org/2000/svg")=>{const a=document.createElementNS(i,n);for(const e in t)a.setAttribute(e,t[e]);return a},S=(n,t,i)=>{const a=[];let e="",r="";for(let s=0,l=t.length;s<l;s++){if(r=t.charAt(s),r===`
`){a.push(e),e="";continue}e+=r,n.measureText(e).width>i&&(a.push(e.substring(0,e.length-1)),e="",s--)}return a.push(e),a},u=async(n,t)=>{const i=m("svg",{xmlns:"http://www.w3.org/2000/svg"}),a=document.createElement("div");a.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),a.style.cssText=`
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  font: ${n.font};
  color: ${t.fontColor};
`,a.innerHTML=`<div class='rich-text-content'>${t.content}</div>`,document.body.appendChild(a),await v(a);const e=a.querySelector(".rich-text-content")?.getBoundingClientRect(),r=e?.width,s=e?.height;document.body.removeChild(a);const l=t.richTextWidth||r||t.width,h=t.richTextHeight||s||t.height;i.setAttribute("width",l.toString()),i.setAttribute("height",h.toString());const c=m("foreignObject",{width:l.toString(),height:h.toString()});return c.appendChild(a),i.appendChild(c),{element:i,width:l,height:h}};async function v(n){const t=n.querySelectorAll("img");for(const i of Array.from(t)){const a=i.getAttribute("src");if(a)try{const r=await(await fetch(a)).blob(),s=await new Promise((l,h)=>{const c=new FileReader;c.onloadend=()=>l(c.result),c.onerror=h,c.readAsDataURL(r)});x(s)&&i.setAttribute("src",s)}catch(e){console.error(`Error converting ${a} to base64:`,e)}}}const p=n=>`data:image/svg+xml;charset=utf-8,${n.outerHTML.replace(/<(img|br|input|hr|embed)(.*?)>/g,"<$1$2/>").replace(/\n/g,"").replace(/\t/g,"").replace(/#/g,"%23")}`,d=(n,t)=>o(n)?t:n,g=(n,t=void 0,i=void 0)=>{const a=new Image;return a.setAttribute("crossOrigin","anonymous"),!o(t)&&(a.width=t),!o(i)&&(a.height=i),a.src=n,new Promise(e=>{a.onload=()=>{e(a)}})},f=(n,t,i)=>Array.from({length:n},()=>new Array(t).fill(i)),k=(n,t)=>{if(!n)return"";const i=Math.random()*6+2,a=Math.random()*2+2;switch(t){case"repeat":return"animation: 200s linear 0s infinite alternate watermark !important;";case"repeat-x":return`animation: ${i}s linear 0s infinite alternate watermark-vertical !important;'`;case"repeat-y":return`animation: ${a}s linear 0s infinite alternate watermark-horizontal !important;'`;case"no-repeat":return`animation: ${i}s linear 0s infinite alternate watermark-horizontal, ${a}s linear 0s infinite alternate watermark-vertical !important;`;default:return""}},O={width:300,height:300,rotate:45,layout:"default",auxiliaryLine:!1,translatePlacement:"middle",contentType:"text",content:"hello watermark-js-plus",textType:"fill",imageWidth:0,imageHeight:0,lineHeight:30,zIndex:2147483647,backgroundPosition:"0 0",backgroundRepeat:"repeat",fontSize:"20px",fontFamily:"sans-serif",fontStyle:"",fontVariant:"",fontColor:"#000",fontWeight:"normal",filter:"none",letterSpacing:"0px",wordSpacing:"0px",globalAlpha:.5,mode:"default",mutationObserve:!0,monitorProtection:!1,movable:!1,parent:"body",onSuccess:()=>{},onBeforeDestroy:()=>{},onDestroyed:()=>{},onObserveError:()=>{}},P=(n,t,i)=>{const a=n.getContext("2d");if(a===null)throw new Error("get context error");a.font=`${t.fontStyle} ${t.fontVariant} ${t.fontWeight} ${t.fontSize} ${t.fontFamily}`,a.filter=t.filter,a.letterSpacing=t.letterSpacing,a.wordSpacing=t.wordSpacing,t?.rotate&&(t.rotate=(360-t.rotate%360)*(Math.PI/180)),o(i.textRowMaxWidth)&&(t.textRowMaxWidth=t.width);const e={image:{rect:{width:t.imageWidth,height:t.imageHeight},position:{x:0,y:0}},textLine:{data:[],yOffsetValue:0},advancedStyleParams:{linear:{x0:0,x1:0},radial:{x0:0,y0:0,r0:0,x1:0,y1:0,r1:0},conic:{x:0,y:0,startAngle:0},pattern:{}}};switch(t.contentType){case"text":e.textLine.data=[t.content];break;case"multi-line-text":e.textLine.data=S(a,t.content,t.textRowMaxWidth);break}let r=t.width/2,s=t.height/2,l="middle",h="center";switch(!o(i?.translateX)&&!o(i?.translateY)?(r=i?.translateX,s=i?.translateY,l="top",h="left"):(e.advancedStyleParams.linear.x0=-t.width/2,e.advancedStyleParams.linear.x1=t.width/2,e.advancedStyleParams.radial.r0=0,e.advancedStyleParams.radial.r1=t.width/2),i.translatePlacement){case"top":r=t.width/2,s=0,l="top",e.advancedStyleParams.linear.x0=-t.width/2,e.advancedStyleParams.linear.x1=t.width/2,e.advancedStyleParams.radial.y0=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.y1=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.y=e.textLine.data.length*t.lineHeight/2;break;case"top-start":r=0,s=0,l="top",h="start",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=t.width,e.advancedStyleParams.radial.x0=t.width/2,e.advancedStyleParams.radial.y0=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.x1=t.width/2,e.advancedStyleParams.radial.y1=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=t.width/2,e.advancedStyleParams.conic.y=e.textLine.data.length*t.lineHeight/2;break;case"top-end":r=t.width,s=0,l="top",h="end",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=-t.width,e.advancedStyleParams.radial.x0=-t.width/2,e.advancedStyleParams.radial.y0=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.x1=-t.width/2,e.advancedStyleParams.radial.y1=e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=-t.width/2,e.advancedStyleParams.conic.y=e.textLine.data.length*t.lineHeight/2;break;case"bottom":r=t.width/2,s=t.height,l="bottom",e.advancedStyleParams.linear.x0=-t.width/2,e.advancedStyleParams.linear.x1=t.width/2,e.advancedStyleParams.radial.y0=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.y1=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=0,e.advancedStyleParams.conic.y=-e.textLine.data.length*t.lineHeight/2;break;case"bottom-start":r=0,s=t.height,l="bottom",h="start",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=t.width,e.advancedStyleParams.radial.x0=t.width/2,e.advancedStyleParams.radial.y0=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.x1=t.width/2,e.advancedStyleParams.radial.y1=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=t.width/2,e.advancedStyleParams.conic.y=-e.textLine.data.length*t.lineHeight/2;break;case"bottom-end":r=t.width,s=t.height,l="bottom",h="end",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=-t.width,e.advancedStyleParams.radial.x0=-t.width/2,e.advancedStyleParams.radial.y0=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.radial.x1=-t.width/2,e.advancedStyleParams.radial.y1=-e.textLine.data.length*t.lineHeight/2,e.advancedStyleParams.conic.x=-t.width/2,e.advancedStyleParams.conic.y=-e.textLine.data.length*t.lineHeight/2;break;case"left":r=0,s=t.height/2,h="start",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=t.width,e.advancedStyleParams.radial.x0=t.width/2,e.advancedStyleParams.radial.x1=t.width/2,e.advancedStyleParams.conic.x=t.width/2,e.advancedStyleParams.conic.y=0;break;case"right":r=t.width,s=t.height/2,h="end",e.advancedStyleParams.linear.x0=0,e.advancedStyleParams.linear.x1=-t.width,e.advancedStyleParams.radial.x0=-t.width/2,e.advancedStyleParams.radial.x1=-t.width/2,e.advancedStyleParams.conic.x=-t.width/2,e.advancedStyleParams.conic.y=0;break}if(t.translateX=r,t.translateY=s,o(i?.textBaseline)&&(t.textBaseline=l),o(i?.textAlign)&&(t.textAlign=h),["text","multi-line-text"].includes(t.contentType))switch(t.textBaseline){case"middle":e.textLine.yOffsetValue=(e.textLine.data.length-1)*t.lineHeight/2;break;case"bottom":case"alphabetic":case"ideographic":e.textLine.yOffsetValue=(e.textLine.data.length-1)*t.lineHeight+(t.lineHeight-parseInt(t.fontSize))/2;break;case"top":case"hanging":e.textLine.yOffsetValue=-t.lineHeight/2+parseInt(t.fontSize)/2;break}return e};class y{constructor(t,i){this.props=t,this.options=i,this.canvas=y.createCanvas(this.options.width,this.options.height),this.recommendOptions=P(this.canvas,this.options,this.props)}static createCanvas(t,i){const a=window.devicePixelRatio||1,e=document.createElement("canvas");return e.width=t*a,e.height=i*a,e.style.width=`${t}px`,e.style.height=`${i}px`,e.getContext("2d")?.setTransform(a,0,0,a,0,0),e}static clearCanvas(t){const i=t.getContext("2d");if(i===null)throw new Error("get context error");i.restore(),i.resetTransform(),i.clearRect(0,0,t.width,t.height);const a=window.devicePixelRatio||1;i.setTransform(a,0,0,a,0,0)}getCanvas(){return this.canvas}clear(){y.clearCanvas(this.canvas)}draw(){const t=this.canvas.getContext("2d");if(t===null)throw new Error("get context error");return this.options.auxiliaryLine&&(t.beginPath(),t.rect(0,0,this.options.width,this.options.height),t.lineWidth=1,t.strokeStyle="#000",t.stroke(),t.closePath(),t.beginPath(),t.rect(this.options.translateX,this.options.translateY,1,1),t.lineWidth=1,t.strokeStyle="#f00",t.stroke(),t.closePath()),this.setStyle(t),t.save(),t.translate(this.options.translateX,this.options.translateY),t.rotate(this.options.rotate),new Promise(i=>{switch(this.options.contentType){case"text":this.drawText(t,i);break;case"image":this.drawImage(t,i);break;case"multi-line-text":this.drawMultiLineText(t,i);break;case"rich-text":this.drawRichText(t,i);break}})}setStyle(t){let i="fillStyle";this.options.textType==="stroke"&&(i="strokeStyle");let a=this.options.fontColor;if(this.options?.advancedStyle)switch(this.options.advancedStyle.type){case"linear":a=this.createLinearGradient(t);break;case"radial":a=this.createRadialGradient(t);break;case"conic":a=this.createConicGradient(t);break;case"pattern":a=this.createPattern(t);break}t[i]&&a&&(t[i]=a),this.options.textAlign&&(t.textAlign=this.options.textAlign),this.options.textBaseline&&(t.textBaseline=this.options.textBaseline),t.globalAlpha=this.options.globalAlpha,this.options.shadowStyle&&(t.shadowBlur=d(this.options.shadowStyle.shadowBlur,0),t.shadowColor=d(this.options.shadowStyle.shadowColor,"#00000000"),t.shadowOffsetX=d(this.options.shadowStyle.shadowOffsetX,0),t.shadowOffsetY=d(this.options.shadowStyle.shadowOffsetY,0)),w(this.options.extraDrawFunc)&&this.options.extraDrawFunc(t)}createLinearGradient(t){const i=t.createLinearGradient(d(this.options.advancedStyle?.params?.linear?.x0,this.recommendOptions.advancedStyleParams.linear.x0),d(this.options.advancedStyle?.params?.linear?.y0,0),d(this.options.advancedStyle?.params?.linear?.x1,this.recommendOptions.advancedStyleParams.linear.x1),d(this.options.advancedStyle?.params?.linear?.y1,0));return this.options?.advancedStyle?.colorStops?.forEach(a=>{i.addColorStop(a.offset,a.color)}),i}createConicGradient(t){const i=t.createConicGradient(d(this.options?.advancedStyle?.params?.conic?.startAngle,0),d(this.options?.advancedStyle?.params?.conic?.x,this.recommendOptions.advancedStyleParams.conic.x),d(this.options?.advancedStyle?.params?.conic?.y,this.recommendOptions.advancedStyleParams.conic.y));return this.options?.advancedStyle?.colorStops?.forEach(a=>{i.addColorStop(a.offset,a.color)}),i}createRadialGradient(t){const i=t.createRadialGradient(d(this.options?.advancedStyle?.params?.radial?.x0,this.recommendOptions.advancedStyleParams.radial.x0),d(this.options?.advancedStyle?.params?.radial?.y0,this.recommendOptions.advancedStyleParams.radial.y0),d(this.options?.advancedStyle?.params?.radial?.r0,this.recommendOptions.advancedStyleParams.radial.r0),d(this.options?.advancedStyle?.params?.radial?.x1,this.recommendOptions.advancedStyleParams.radial.x1),d(this.options?.advancedStyle?.params?.radial?.y1,this.recommendOptions.advancedStyleParams.radial.y1),d(this.options?.advancedStyle?.params?.radial?.r1,this.recommendOptions.advancedStyleParams.radial.r1));return this.options?.advancedStyle?.colorStops?.forEach(a=>{i.addColorStop(a.offset,a.color)}),i}createPattern(t){return t.createPattern(this.options?.advancedStyle?.params?.pattern?.image,this.options?.advancedStyle?.params?.pattern?.repetition||"")}setText(t,i){let a="fillText";this.options.textType==="stroke"&&(a="strokeText"),t[a]&&t[a](i.text,i.x,i.y,i.maxWidth)}drawText(t,i){this.setText(t,{text:this.options.content,x:0,y:0-this.recommendOptions.textLine.yOffsetValue,maxWidth:this.options.textRowMaxWidth||this.options.width}),i(t.canvas)}drawImage(t,i){g(this.options.image).then(a=>{const{width:e,height:r}=this.getImageRect(a),s=this.getDrawImagePosition(e,r);t.drawImage(a,s.x,s.y,e,r),i(t.canvas)})}drawMultiLineText(t,i){const a=this.recommendOptions.textLine.data,e=this.recommendOptions.textLine.yOffsetValue;a.forEach((r,s)=>{this.setText(t,{text:r,x:0,y:this.options.lineHeight*s-e,maxWidth:this.options.textRowMaxWidth||this.options.width})}),i(t.canvas)}async drawRichText(t,i){const a=await u(t,this.options);g(p(a.element),a.width,a.height).then(e=>{const r=this.getDrawImagePosition(e.width,e.height);t.drawImage(e,r.x,r.y,e.width,e.height),i(t.canvas)})}getImageRect(t){const i={width:this.options.imageWidth||0,height:this.options.imageHeight||0};switch(!0){case(i.width!==0&&i.height===0):i.height=i.width*t.height/t.width;break;case(i.width===0&&i.height!==0):i.width=i.height*t.width/t.height;break;case(i.width===0&&i.height===0):i.width=t.width,i.height=t.height;break}return i}getDrawImagePosition(t,i){const a={x:-t/2,y:-i/2};switch(this.options.translatePlacement){case"top":a.x=-t/2,a.y=0;break;case"top-start":a.x=0,a.y=0;break;case"top-end":a.x=-t,a.y=0;break;case"bottom":a.x=-t/2,a.y=-i;break;case"bottom-start":a.x=0,a.y=-i;break;case"bottom-end":a.x=-t,a.y=-i;break;case"left":a.x=0,a.y=-i/2;break;case"right":a.x=-t,a.y=-i/2;break}return!o(this.props?.translateX)&&(a.x=0),!o(this.props?.translateY)&&(a.y=0),a}}class b{constructor(t,i){this.options=t,this.partialWidth=this.options.width,this.partialHeight=this.options.height,this.rows=this.options.gridLayoutOptions?.rows||1,this.cols=this.options.gridLayoutOptions?.cols||1,this.matrix=this.options.gridLayoutOptions?.matrix||f(this.rows,this.cols,1),this.gap=this.options.gridLayoutOptions?.gap||[0,0],this.partialCanvas=i}draw(){const t=y.createCanvas(this.options.gridLayoutOptions?.width||this.partialWidth*this.cols+this.gap[0]*this.cols,this.options.gridLayoutOptions?.height||this.partialHeight*this.rows+this.gap[1]*this.rows),i=t.getContext("2d");this.options.gridLayoutOptions?.backgroundImage&&i?.drawImage(this.options.gridLayoutOptions?.backgroundImage,0,0,this.options.gridLayoutOptions?.width,this.options.gridLayoutOptions?.height);for(let a=0;a<this.rows;a++)for(let e=0;e<this.cols;e++)this.matrix?.[a]?.[e]&&i?.drawImage(this.partialCanvas,this.partialWidth*e+this.gap[0]*e,this.partialHeight*a+this.gap[1]*a,this.partialWidth,this.partialHeight);return t}}const C=(n,t)=>n.layout==="grid"?new b(n,t).draw():t,H=n=>{if(n.layout==="grid"){const t=n.gridLayoutOptions?.cols||1,i=n.gridLayoutOptions?.rows||1,a=n.gridLayoutOptions?.gap||[0,0];return[n.width*t+a[0]*t,n.height*i+a[1]*i]}else return[n.width,n.height]};export{y as W,o as a,k as b,L as c,w as d,H as g,O as i,g as l,C as r};
