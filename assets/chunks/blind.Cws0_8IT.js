import{i as b,W as d,a as v,r as g,c as w,g as E,b as y}from"./index.E5uUK3Fu.js";const f=l=>{typeof window>"u"||l&&(Object.defineProperty(window,"MutationObserver",{writable:!1,configurable:!1}),Object.defineProperty(window,"requestAnimationFrame",{writable:!1,configurable:!1}))};class C{constructor(t={}){this.parentElement=document.body,this.isCreating=!1,this.props=t,this.options={...b,...t},this.changeParentElement(this.options.parent),this.watermarkCanvas=new d(this.props,this.options),f(this.options.monitorProtection)}async changeOptions(t={},i="overwrite",e=!0){this.initConfigData(t,i),f(this.options.monitorProtection),e&&(this.remove(),await this.create())}async create(){var m,r,a,h,c,p,n;if(this.isCreating)return;if(this.isCreating=!0,!this.validateUnique()){this.isCreating=!1;return}if(!this.validateContent()){this.isCreating=!1;return}const t=v(this.watermarkDom);await((m=this.watermarkCanvas)==null?void 0:m.draw()),this.layoutCanvas=g(this.options,(r=this.watermarkCanvas)==null?void 0:r.getCanvas());const i=w(this.layoutCanvas);(a=this.watermarkCanvas)==null||a.clear(),this.watermarkDom=document.createElement("div");const e=document.createElement("div");this.watermarkDom.__WATERMARK__="watermark",this.watermarkDom.__WATERMARK__INSTANCE__=this;const s=this.checkParentElementType();this.watermarkDom.style.cssText=`
      z-index:${this.options.zIndex}!important;display:block!important;visibility:visible!important;transform:none!important;scale:none!important;
      ${s==="custom"?"top:0!important;bottom:0!important;left:0!important;right:0!important;height:100%!important;pointer-events:none!important;position:absolute!important;":"position:relative!important;"}
    `;const o=E(this.options);if(e.style.cssText=`
      display:block!important;visibility:visible!important;pointer-events:none;top:0;bottom:0;left:0;right:0;transform:none!important;scale:none!important;
      position:${s==="root"?"fixed":"absolute"}!important;-webkit-print-color-adjust:exact!important;width:100%!important;height:100%!important;
      z-index:${this.options.zIndex}!important;background-image:url(${i})!important;background-repeat:${this.options.backgroundRepeat}!important;
      background-size:${o[0]}px ${o[1]}px!important;background-position:${this.options.backgroundPosition};
      ${this.options.movable?"animation: 200s ease 0s infinite normal none running watermark !important;":""}
    `,this.watermarkDom.appendChild(e),this.parentElement.appendChild(this.watermarkDom),this.options.mutationObserve)try{this.bindMutationObserve()}catch{(c=(h=this.options).onObserveError)==null||c.call(h)}t&&((n=(p=this.options).onSuccess)==null||n.call(p)),this.isCreating=!1}destroy(){this.remove(),this.watermarkDom=void 0}async check(){return this.parentElement.contains(this.watermarkDom)}remove(){var t,i,e,s,o,m,r,a;(i=(t=this.options).onBeforeDestroy)==null||i.call(t),(e=this.observer)==null||e.disconnect(),(s=this.parentObserve)==null||s.disconnect(),this.unbindCheckWatermarkElementEvent(),(m=(o=this.watermarkDom)==null?void 0:o.parentNode)==null||m.removeChild(this.watermarkDom),(a=(r=this.options).onDestroyed)==null||a.call(r)}initConfigData(t,i="overwrite"){i==="append"?Object.keys(t).forEach(e=>{this.props&&(this.props[e]=t[e])}):this.props=t,this.options={...b,...this.props},this.changeParentElement(this.options.parent),this.watermarkCanvas=new d(this.props,this.options)}changeParentElement(t){if(typeof t=="string"){const i=document.querySelector(t);i&&(this.parentElement=i)}else this.parentElement=t;this.parentElement||console.error("[WatermarkJsPlus]: please pass a valid parent element.")}validateUnique(){let t=!0;return Array.from(this.parentElement.childNodes).forEach(i=>{t&&Object.hasOwnProperty.call(i,"__WATERMARK__")&&(t=!1)}),t}validateContent(){switch(this.options.contentType){case"image":return Object.hasOwnProperty.call(this.options,"image");case"multi-line-text":case"rich-text":case"text":return this.options.content.length>0}}checkParentElementType(){return["html","body"].includes(this.parentElement.tagName.toLocaleLowerCase())?"root":"custom"}async checkWatermarkElement(){this.parentElement.contains(this.watermarkDom)||(this.remove(),await this.create()),this.bindCheckWatermarkElementEvent()}bindMutationObserve(){this.watermarkDom&&(this.bindCheckWatermarkElementEvent(),this.observer=new MutationObserver(async t=>{t.length>0&&(this.remove(),await this.create())}),this.observer.observe(this.watermarkDom,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.parentObserve=new MutationObserver(async t=>{var i;for(const e of t)((e==null?void 0:e.target)===this.watermarkDom||((i=e==null?void 0:e.removedNodes)==null?void 0:i[0])===this.watermarkDom||e.type==="childList"&&e.target===this.parentElement&&e.target.lastChild!==this.watermarkDom)&&(this.remove(),await this.create())}),this.parentObserve.observe(this.parentElement,{attributes:!0,childList:!0,subtree:!0,characterData:!0}))}bindCheckWatermarkElementEvent(){this.unbindCheckWatermarkElementEvent(),this.checkWatermarkElementRequestID=requestAnimationFrame(this.checkWatermarkElement.bind(this))}unbindCheckWatermarkElementEvent(){v(this.checkWatermarkElementRequestID)||cancelAnimationFrame(this.checkWatermarkElementRequestID)}}class O extends C{constructor(t={}){const i={globalAlpha:.005,mode:"blind"};super({...t,...i})}static decode(t){const{url:i="",fillColor:e="#000",compositeOperation:s="color-burn",mode:o="canvas",compositeTimes:m=3,onSuccess:r}=t;if(i&&o==="canvas"){const a=new Image;a.src=i,a.addEventListener("load",()=>{const{width:h,height:c}=a,p=d.createCanvas(h,c),n=p.getContext("2d");if(!n)throw new Error("get context error");n.drawImage(a,0,0,h,c),n.globalCompositeOperation=s,n.fillStyle=e;for(let k=0;k<m;k++)n.fillRect(0,0,h,c);const u=w(p);y(r)&&(r==null||r(u))})}}}export{O as B,C as W};
