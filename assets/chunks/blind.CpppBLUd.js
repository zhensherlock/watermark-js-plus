import{i as v,W as p,a as g,r as k,c as b,g as y,b as C,d as E}from"./index.B_48g37t.js";const c=n=>{typeof window>"u"||n&&Object.defineProperty(window,"MutationObserver",{writable:!1,configurable:!1})};class D{constructor(t={}){this.parentElement=document.body,this.isCreating=!1,this.props=t,this.options={...v,...t},this.changeParentElement(this.options.parent),this.watermarkCanvas=new p(this.props,this.options),c(this.options.monitorProtection)}async changeOptions(t={},e="overwrite",i=!0){this.initConfigData(t,e),c(this.options.monitorProtection),i&&(this.remove(),await this.create())}async create(){if(this.isCreating)return;if(this.isCreating=!0,!this.validateUnique()){this.isCreating=!1;return}if(!this.validateContent()){this.isCreating=!1;return}const t=g(this.watermarkDom);await this.watermarkCanvas?.draw(),this.layoutCanvas=k(this.options,this.watermarkCanvas?.getCanvas());const e=b(this.layoutCanvas);this.watermarkCanvas?.clear(),this.watermarkDom=document.createElement("div");const i=document.createElement("div");this.watermarkDom.__WATERMARK__="watermark",this.watermarkDom.__WATERMARK__INSTANCE__=this;const a=this.checkParentElementType();this.watermarkDom.style.cssText=`
      z-index:${this.options.zIndex}!important;display:block!important;visibility:visible!important;transform:none!important;scale:none!important;
      ${a==="custom"?"top:0!important;bottom:0!important;left:0!important;right:0!important;height:100%!important;pointer-events:none!important;position:absolute!important;":"position:relative!important;"}
    `;const o=y(this.options);if(i.style.cssText=`
      display:block!important;visibility:visible!important;pointer-events:none;top:0;bottom:0;left:0;right:0;transform:none!important;scale:none!important;
      position:${a==="root"?"fixed":"absolute"}!important;-webkit-print-color-adjust:exact!important;width:100%!important;height:100%!important;
      z-index:${this.options.zIndex}!important;background-image:url(${e})!important;background-repeat:${this.options.backgroundRepeat}!important;
      background-size:${o[0]}px ${o[1]}px!important;background-position:${this.options.backgroundPosition};
      ${C(this.options.movable,this.options.backgroundRepeat)}
    `,this.watermarkDom.appendChild(i),this.parentElement.appendChild(this.watermarkDom),this.options.mutationObserve)try{this.bindMutationObserve()}catch{this.options.onObserveError?.()}t&&this.options.onSuccess?.(),this.isCreating=!1}destroy(){this.remove(),this.watermarkDom=void 0}async check(){return this.parentElement.contains(this.watermarkDom)}remove(){this.options.onBeforeDestroy?.(),this.observer?.disconnect(),this.parentObserve?.disconnect(),this.watermarkDom?.parentNode?.removeChild(this.watermarkDom),this.options.onDestroyed?.()}initConfigData(t,e="overwrite"){e==="append"?Object.keys(t).forEach(i=>{this.props&&(this.props[i]=t[i])}):this.props=t,this.options={...v,...this.props},this.changeParentElement(this.options.parent),this.watermarkCanvas=new p(this.props,this.options)}changeParentElement(t){if(typeof t=="string"){const e=document.querySelector(t);e&&(this.parentElement=e)}else this.parentElement=t;this.parentElement||console.error("[WatermarkJsPlus]: please pass a valid parent element.")}validateUnique(){let t=!0;return Array.from(this.parentElement.childNodes).forEach(e=>{t&&Object.hasOwnProperty.call(e,"__WATERMARK__")&&(t=!1)}),t}validateContent(){switch(this.options.contentType){case"image":return Object.hasOwnProperty.call(this.options,"image");case"multi-line-text":case"rich-text":case"text":return this.options.content.length>0}}checkParentElementType(){return["html","body"].includes(this.parentElement.tagName.toLocaleLowerCase())?"root":"custom"}bindMutationObserve(){this.watermarkDom&&(this.observer=new MutationObserver(async t=>{t.length>0&&(this.remove(),await this.create())}),this.observer.observe(this.watermarkDom,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.parentObserve=new MutationObserver(async t=>{for(const e of t)(e?.target===this.watermarkDom||e?.removedNodes?.[0]===this.watermarkDom||e.type==="childList"&&e.target===this.parentElement&&e.target.lastChild!==this.watermarkDom)&&(this.remove(),await this.create())}),this.parentObserve.observe(this.parentElement,{attributes:!0,childList:!0,subtree:!0,characterData:!0}))}}class x extends D{constructor(t={}){const e={globalAlpha:.005,mode:"blind"};super({...t,...e})}async changeOptions(t={},e="overwrite",i=!0){t.globalAlpha=.005,t.mode="blind",this.initConfigData(t,e),c(this.options.monitorProtection),i&&(this.remove(),await this.create())}static decode(t){const{url:e="",fillColor:i="#000",compositeOperation:a="color-burn",mode:o="canvas",compositeTimes:f=3,onSuccess:l}=t;if(e&&o==="canvas"){const s=new Image;s.src=e,s.addEventListener("load",()=>{const{width:h,height:m}=s,d=p.createCanvas(h,m),r=d.getContext("2d");if(!r)throw new Error("get context error");r.drawImage(s,0,0,h,m),r.globalCompositeOperation=a,r.fillStyle=i;for(let u=0;u<f;u++)r.fillRect(0,0,h,m);const w=b(d);E(l)&&l?.(w)})}}}export{x as B,D as W};
